<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Spanza WASM Test</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }

        #output {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            min-height: 100px;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }

        .status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .loading {
            background: #fff3cd;
        }

        .ready {
            background: #d4edda;
        }

        .error {
            background: #f8d7da;
        }
    </style>
</head>

<body>
    <h1>Spanza WASM Test</h1>

    <!-- Status indicator -->
    <div id="status" class="status loading">Loading WASM module...</div>

    <!-- Control buttons -->
    <div style="margin: 20px 0;">
        <button id="testBtn" disabled>Test: hello()</button>
        <button id="testDerp" disabled>Test derp only</button>
        <button id="derpPingBtn" disabled>Test DERP Ping-Pong</button>
        <button id="connectBtn" disabled>Connect WireGuard + DERP</button>
        <button id="statusBtn" disabled>Get Status</button>
        <button id="pingBtn" disabled>Ping 192.168.4.1 (ICMP)</button>
        <button id="fetchBtn" disabled>Fetch http://192.168.4.1/</button>
    </div>

    <!-- Output area -->
    <div id="output"></div>

    <!--
    wasm_exec.js: The JavaScript-Go bridge for WebAssembly

    This file is the runtime that allows Go code to run in the browser.
    It provides:
    1. The "Go" class that manages WASM lifecycle
    2. Memory sharing between JavaScript and Go
    3. Type conversions (Go strings ↔ JS strings, etc.)
    4. Implementation of Go's syscall/js package (js.Global(), js.Value, etc.)
    5. Fake OS interfaces (filesystem, timers, crypto) since WASM has no OS

    When Go compiles to WASM, it generates imports for these functions.
    This file provides the JavaScript implementations.
    -->
    <script src="wasm_exec.js"></script>

    <script>
        // This function loads and runs the WASM module
        async function loadWasm() {
            try {
                // Create a new Go instance
                // This sets up the Go runtime environment
                const go = new Go();

                // Fetch the WASM binary and instantiate it
                // go.importObject contains all the imports that Go needs
                // (memory, functions for syscalls, etc.)
                const result = await WebAssembly.instantiateStreaming(
                    fetch("wasm/main.wasm"),
                    go.importObject
                );

                // Start the Go program
                // This runs the main() function in our Go code
                // We don't await this because main() runs forever
                go.run(result.instance);

                // Update UI to show we're ready
                document.getElementById("status").textContent = "WASM module loaded! ✓ Ready to connect.";
                document.getElementById("status").className = "status ready";
                document.getElementById("testBtn").disabled = false;
                document.getElementById("testDerp").disabled = false;
                document.getElementById("derpPingBtn").disabled = false;
                document.getElementById("connectBtn").disabled = false;
                document.getElementById("statusBtn").disabled = false;
                document.getElementById("pingBtn").disabled = false;
                document.getElementById("fetchBtn").disabled = false;

            } catch (err) {
                console.error("Failed to load WASM:", err);
                document.getElementById("status").textContent = "Error loading WASM: " + err;
                document.getElementById("status").className = "status error";
            }
        }

        function logOutput(msg) {
            const output = document.getElementById("output");
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${msg}\n`;
            // Auto-scroll to bottom to see newest messages
            output.scrollTop = output.scrollHeight;
        }

        // Test button - calls hello()
        document.getElementById("testBtn").addEventListener("click", () => {
            const result = hello();
            logOutput("hello() returned: " + result);
        });

        // DERP Ping button - tests raw DERP ping-pong (no WireGuard)
        document.getElementById("derpPingBtn").addEventListener("click", () => {
            logOutput("Testing DERP ping-pong (no WireGuard)...");
            logOutput("This will create a fresh DERP connection and send PING, expecting PONG");
            try {
                const result = testDerpPing();
                if (result.success) {
                    logOutput("✓ DERP PING-PONG SUCCESS!");
                    logOutput(`  Message: ${result.message}`);
                    logOutput(`  Total time: ${result.totalMs}ms`);
                    logOutput(`  RTT: ${result.rttMs}ms`);
                    logOutput(`  Breakdown: ${result.breakdown}`);
                } else {
                    logOutput("✗ DERP PING-PONG FAILED: " + result.error);
                }
            } catch (err) {
                logOutput("ERROR calling testDerpPing: " + err);
            }
        });

        // TestDerpOnly
        document.getElementById("testDerp").addEventListener("click", () => {
            logOutput("Calling testDerpOnly()...");
            try {
                const result = testDerpOnly();
                logOutput("testDerpOnly() result: " + JSON.stringify(result, null, 2));
            } catch (err) {
                logOutput("ERROR: " + err);
            }
        });


        // Connect button - creates WireGuard + DERP connection
        document.getElementById("connectBtn").addEventListener("click", () => {
            logOutput("Calling createWireGuard()...");
            try {
                const result = createWireGuard();
                logOutput("createWireGuard() result: " + JSON.stringify(result, null, 2));

                if (result.success) {
                    document.getElementById("status").textContent =
                        `✓ Connected! ${result.localIP} ↔ DERP ↔ ${result.peerIP}`;
                    document.getElementById("status").className = "status ready";
                } else {
                    document.getElementById("status").textContent = "Error: " + result.error;
                    document.getElementById("status").className = "status error";
                }
            } catch (err) {
                logOutput("ERROR: " + err);
                document.getElementById("status").textContent = "Error: " + err;
                document.getElementById("status").className = "status error";
            }
        });

        // Status button - gets current status
        document.getElementById("statusBtn").addEventListener("click", () => {
            try {
                const status = getStatus();
                logOutput("Status: " + JSON.stringify(status, null, 2));
            } catch (err) {
                logOutput("ERROR getting status: " + err);
            }
        });

        // Ping button - sends ICMP ping through tunnel
        document.getElementById("pingBtn").addEventListener("click", () => {
            logOutput("Calling pingPeer()...");
            try {
                const result = pingPeer();
                if (result.success) {
                    logOutput("✓ PING SUCCESS!");
                    logOutput(result.message);
                    logOutput("Received " + result.bytes + " bytes");
                } else {
                    logOutput("PING FAILED: " + result.error);
                }
            } catch (err) {
                logOutput("ERROR calling pingPeer: " + err);
            }
        });

        // Fetch button - makes HTTP request through tunnel
        document.getElementById("fetchBtn").addEventListener("click", () => {
            logOutput("Calling fetchHTTP()...");
            try {
                const result = fetchHTTP();
                if (result.success) {
                    logOutput("✓ HTTP Response received!");
                    logOutput("Status: " + result.statusText);
                    logOutput("Body: " + result.body);
                    logOutput("Full response: " + JSON.stringify(result, null, 2));
                } else {
                    logOutput("ERROR: " + result.error);
                }
            } catch (err) {
                logOutput("ERROR calling fetchHTTP: " + err);
            }
        });

        // Load the WASM module when page loads
        loadWasm();
    </script>
</body>

</html>
